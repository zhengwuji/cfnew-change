name: Auto Release on Build Complete

on:
  push:
    branches:
      - '**'
    paths:
      - 'å°‘å¹´ä½ ç›¸ä¿¡å…‰å—'

jobs:
  create-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get current date
        id: date
        run: |
          echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
          echo "datetime=$(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT
          echo "timestamp=$(date +'%Y%m%d%H%M%S')" >> $GITHUB_OUTPUT

      - name: Generate changelog
        run: |
          cat > changelog.txt << 'EOF'
          æ›´æ–°æ—¥å¿— / Update Log
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

          æ›´æ–°æ—¶é—´ / Update Time: ${{ steps.date.outputs.datetime }}
          ç‰ˆæœ¬æ ‡ç­¾ / Version Tag: build-${{ steps.date.outputs.timestamp }}

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

          æœ¬æ¬¡æ›´æ–°å†…å®¹ / Changes:
          
          âœ… æ˜Žæ–‡ä»£ç å·²æ›´æ–°å¹¶å®Œæˆæ··æ·†å¤„ç†
          âœ… Source code updated and obfuscated
          
          ðŸ“¦ Workerè„šæœ¬å·²è‡ªåŠ¨æž„å»º
          ðŸ“¦ Worker script auto-built
          
          ðŸš€ å¯ç›´æŽ¥éƒ¨ç½²åˆ°Cloudflare Workers/Pages
          ðŸš€ Ready to deploy to Cloudflare Workers/Pages

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

          éƒ¨ç½²è¯´æ˜Ž / Deployment Instructions:
          
          1. ä¸‹è½½ å°‘å¹´ä½ ç›¸ä¿¡å…‰å—.txt æ–‡ä»¶
             Download å°‘å¹´ä½ ç›¸ä¿¡å…‰å—.txt file
          
          2. é‡å‘½åä¸º _worker.js (Pages) æˆ–ç›´æŽ¥ä½¿ç”¨ (Workers)
             Rename to _worker.js (Pages) or use directly (Workers)
          
          3. ä¸Šä¼ åˆ° Cloudflare å³å¯ä½¿ç”¨
             Upload to Cloudflare and enjoy

          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          EOF

      - name: Copy and rename worker file
        run: |
          cp "å°‘å¹´ä½ ç›¸ä¿¡å…‰å—" "å°‘å¹´ä½ ç›¸ä¿¡å…‰å—.txt"
          echo "Workeræ–‡ä»¶å·²å¤åˆ¶ä¸ºtxtæ ¼å¼"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ steps.date.outputs.timestamp }}
          name: æž„å»ºå‘å¸ƒ ${{ steps.date.outputs.date }}
          body: |
            ## ðŸ“¦ è‡ªåŠ¨æž„å»ºå‘å¸ƒ
            
            **æž„å»ºæ—¶é—´**: ${{ steps.date.outputs.datetime }}
            **ç‰ˆæœ¬æ ‡ç­¾**: build-${{ steps.date.outputs.timestamp }}
            
            ---
            
            ### ðŸ“ æ›´æ–°è¯´æ˜Ž
            
            - âœ… æ˜Žæ–‡ä»£ç å·²æ›´æ–°å¹¶å®Œæˆæ··æ·†å¤„ç†
            - ðŸ“¦ Workerè„šæœ¬å·²è‡ªåŠ¨æž„å»ºå®Œæˆ
            - ðŸš€ å¯ç›´æŽ¥éƒ¨ç½²åˆ°Cloudflare Workers/Pages
            
            ### ðŸ“¥ ä¸‹è½½æ–‡ä»¶
            
            | æ–‡ä»¶å | è¯´æ˜Ž |
            |--------|------|
            | `å°‘å¹´ä½ ç›¸ä¿¡å…‰å—.txt` | æ··æ·†åŽçš„Workerè„šæœ¬ï¼ˆtxtæ ¼å¼ï¼‰ |
            | `changelog.txt` | è¯¦ç»†æ›´æ–°æ—¥å¿— |
            
            ### ðŸš€ å¿«é€Ÿéƒ¨ç½²
            
            1. ä¸‹è½½ `å°‘å¹´ä½ ç›¸ä¿¡å…‰å—.txt` æ–‡ä»¶
            2. Cloudflare Pages: é‡å‘½åä¸º `_worker.js` åŽä¸Šä¼ 
            3. Cloudflare Workers: ç›´æŽ¥å¤åˆ¶å†…å®¹åˆ°ç¼–è¾‘å™¨
            
            ---
            
            > ðŸ’¡ æ­¤ç‰ˆæœ¬ç”±GitHub Actionsè‡ªåŠ¨æž„å»ºå¹¶å‘å¸ƒ
          draft: false
          prerelease: false
          files: |
            å°‘å¹´ä½ ç›¸ä¿¡å…‰å—.txt
            changelog.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Output summary
        run: |
          echo "## ðŸŽ‰ Releaseå‘å¸ƒæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **å‘å¸ƒæ—¶é—´**: ${{ steps.date.outputs.datetime }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬æ ‡ç­¾**: build-${{ steps.date.outputs.timestamp }}" >> $GITHUB_STEP_SUMMARY
          echo "- **åŒ…å«æ–‡ä»¶**: å°‘å¹´ä½ ç›¸ä¿¡å…‰å—.txt, changelog.txt" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¥ ä¸‹è½½é“¾æŽ¥" >> $GITHUB_STEP_SUMMARY
          echo "https://github.com/${{ github.repository }}/releases/tag/build-${{ steps.date.outputs.timestamp }}" >> $GITHUB_STEP_SUMMARY
