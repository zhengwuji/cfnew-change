name: Generate and Obfuscate Worker Script

on:
  workflow_dispatch:
  push:
    branches:
      - '**'  # ä»…åŒ¹é…åˆ†æ”¯æ¨é€ï¼Œæ’é™¤æ ‡ç­¾æ¨é€
    paths:
      - 'æ˜æ–‡æºå—'
      - '.github/workflows/obfuscate.yml'

jobs:
  build-and-obfuscate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Obfuscator and dependencies
        run: |
          npm install javascript-obfuscator
          npm install acorn

      - name: Obfuscate from local source file
        run: |
          cat > obfuscate.js << 'EOF'
          const JavaScriptObfuscator = require('javascript-obfuscator');
          const fs = require('fs');
          const path = require('path');
          
          const sourceFileName = 'æ˜æ–‡æºå—';
          const outputFileName = 'å°‘å¹´ä½ ç›¸ä¿¡å…‰å—';
          const sourceFilePath = path.join(process.cwd(), sourceFileName);

          if (!fs.existsSync(sourceFilePath)) {
            console.error('é”™è¯¯ï¼šåœ¨è·¯å¾„ \'' + sourceFilePath + '\' æœªæ‰¾åˆ°æºæ–‡ä»¶ã€‚è¯·ç¡®ä¿æ‚¨çš„ä»“åº“æ ¹ç›®å½•æœ‰åä¸º \'æ˜æ–‡æºå—\' çš„æ–‡ä»¶ã€‚');
            process.exit(1);
          }

          const originalCode = fs.readFileSync(sourceFilePath, 'utf8');

          if (!originalCode || originalCode.trim().length === 0) {
            console.error('é”™è¯¯ï¼šæºæ–‡ä»¶ ' + sourceFileName + ' ä¸ºç©ºã€‚');
            process.exit(1);
          }

          console.log('æºæ–‡ä»¶å¤§å°: ' + originalCode.length + ' å­—ç¬¦');
          console.log('å¼€å§‹è§£æä»£ç ...');

          // å°è¯•ä½¿ç”¨ç®€å•çš„ AST è§£ææ¥æ£€æŸ¥è¯­æ³•
          try {
            const acorn = require('acorn');
            acorn.parse(originalCode, { ecmaVersion: 2022, sourceType: 'module' });
            console.log('ä»£ç è¯­æ³•æ£€æŸ¥é€šè¿‡');
          } catch (parseError) {
            console.error('ä»£ç è¯­æ³•é”™è¯¯:', parseError.message);
            console.error('é”™è¯¯ä½ç½®: è¡Œ ' + parseError.loc?.line + ', åˆ— ' + parseError.loc?.column);
            // ç»§ç»­æ‰§è¡Œï¼Œè®©æ··æ·†å™¨è‡ªå·±å¤„ç†
          }

          // ============================================
          // âš ï¸ æ··æ·†å¼ºåº¦ä¿æŠ¤æœºåˆ¶
          // âš ï¸ é‡è¦ï¼šæ··æ·†å¼ºåº¦ä¸èƒ½é™ä½ï¼Œåªèƒ½å¢åŠ æˆ–ä¿æŒä¸å˜
          // âš ï¸ ä»¥ä¸‹å®šä¹‰çš„æ˜¯æœ€å°å…è®¸å€¼ï¼Œä»»ä½•ä½äºè¿™äº›å€¼çš„é…ç½®éƒ½ä¼šè¢«æ‹’ç»
          // ============================================
          
          // å®šä¹‰æ··æ·†å¼ºåº¦æœ€å°å€¼ï¼ˆè¿™äº›å€¼ä¸èƒ½é™ä½ï¼‰
          const MIN_OBFUSCATION_VALUES = {
              // å¿…é¡»å¯ç”¨çš„é€‰é¡¹ï¼ˆå¿…é¡»ä¸ºtrueï¼‰
              compact: true,
              controlFlowFlattening: true,
              deadCodeInjection: true,
              stringArray: true,
              stringArrayRotate: true,
              stringArrayShuffle: true,
              renameGlobals: true,
              numbersToExpressions: true,
              simplify: true,
              splitStrings: true,
              unicodeEscapeSequence: true,
              disableConsoleOutput: true,
              
              // é˜ˆå€¼æœ€å°å€¼ï¼ˆåªèƒ½ >= è¿™äº›å€¼ï¼‰
              controlFlowFlatteningThreshold: 1,        // æœ€å°å€¼ï¼š1ï¼ˆæœ€å¤§å¼ºåº¦ï¼‰
              deadCodeInjectionThreshold: 1,            // æœ€å°å€¼ï¼š1ï¼ˆæœ€å¤§å¼ºåº¦ï¼‰
              stringArrayThreshold: 1.0,                // æœ€å°å€¼ï¼š1.0ï¼ˆ100%ï¼‰
              stringArrayWrappersCount: 2,              // æœ€å°å€¼ï¼š2
              stringArrayWrappersParametersMaxCount: 3, // æœ€å°å€¼ï¼š3
              splitStringsChunkLength: 1                // æœ€å°å€¼ï¼š1ï¼ˆæœ€å°å—é•¿åº¦ï¼Œå¼ºåº¦æœ€é«˜ï¼‰
          };

          // ============================================
          // å½“å‰æ··æ·†é…ç½®ï¼ˆå¯ä»¥å¢åŠ ä½†ä¸èƒ½é™ä½ï¼‰
          // ä¿®æ”¹è¯´æ˜ï¼š
          //   - æ•°å€¼é€‰é¡¹ï¼šåªèƒ½å¢åŠ ï¼Œä¸èƒ½å‡å°‘
          //   - å¸ƒå°”é€‰é¡¹ï¼ˆMINä¸­ä¸ºtrueçš„ï¼‰ï¼šå¿…é¡»ä¿æŒä¸ºtrue
          //   - å¦‚æœè¦å¢å¼ºæ··æ·†ï¼Œå¯ä»¥å¢åŠ æ•°å€¼æˆ–å¯ç”¨æ›´å¤šé€‰é¡¹
          // ============================================
          const obfuscationOptions = {
              compact: true,
              controlFlowFlattening: true,
              controlFlowFlatteningThreshold: 1,      // âš ï¸ æœ€å°å€¼ï¼š1ï¼Œåªèƒ½ >= 1
              deadCodeInjection: true,
              deadCodeInjectionThreshold: 1,          // âš ï¸ æœ€å°å€¼ï¼š1ï¼Œåªèƒ½ >= 1
              stringArray: true,
              stringArrayEncoding: ['base64'],        // âš ï¸ å¯ä»¥æ·»åŠ æ›´å¤šç¼–ç ï¼Œä½†å¿…é¡»åŒ…å«base64
              stringArrayThreshold: 1.0,              // âš ï¸ æœ€å°å€¼ï¼š1.0ï¼Œåªèƒ½ >= 1.0
              stringArrayRotate: true,
              stringArrayShuffle: true,
              stringArrayWrappersCount: 2,            // âš ï¸ æœ€å°å€¼ï¼š2ï¼Œåªèƒ½ >= 2
              stringArrayWrappersChainedCalls: false,
              stringArrayWrappersParametersMaxCount: 3, // âš ï¸ æœ€å°å€¼ï¼š3ï¼Œåªèƒ½ >= 3
              renameGlobals: true,
              identifierNamesGenerator: 'mangled-shuffled', // âš ï¸ å¯ä»¥å¢å¼ºä½†ä¸èƒ½é™çº§
              identifierNamesCache: null,
              identifiersPrefix: '',
              renameProperties: false,
              renamePropertiesMode: 'safe',
              ignoreImports: false,
              target: 'browser',
              numbersToExpressions: true,
              simplify: true,
              splitStrings: true,
              splitStringsChunkLength: 1,             // âš ï¸ æœ€å°å€¼ï¼š1ï¼Œåªèƒ½ >= 1
              transformObjectKeys: false,
              unicodeEscapeSequence: true,
              selfDefending: false,                   // å¯ä»¥æ”¹ä¸ºtrueå¢å¼ºï¼Œä½†ä¸èƒ½ä»trueæ”¹ä¸ºfalse
              debugProtection: false,                 // å¯ä»¥æ”¹ä¸ºtrueå¢å¼ºï¼Œä½†ä¸èƒ½ä»trueæ”¹ä¸ºfalse
              debugProtectionInterval: 0,
              disableConsoleOutput: true,
              domainLock: []
          };

          // ============================================
          // éªŒè¯æ··æ·†å¼ºåº¦ï¼ˆç¡®ä¿ä¸ä½äºæœ€å°å€¼ï¼‰
          // ============================================
          console.log('ğŸ” éªŒè¯æ··æ·†å¼ºåº¦é…ç½®...');
          const validationErrors = [];
          
          // éªŒè¯é˜ˆå€¼ä¸èƒ½é™ä½
          if (obfuscationOptions.controlFlowFlatteningThreshold < MIN_OBFUSCATION_VALUES.controlFlowFlatteningThreshold) {
              validationErrors.push('controlFlowFlatteningThreshold (' + obfuscationOptions.controlFlowFlatteningThreshold + 
                                   ') ä¸èƒ½ä½äºæœ€å°å€¼ ' + MIN_OBFUSCATION_VALUES.controlFlowFlatteningThreshold);
          }
          if (obfuscationOptions.deadCodeInjectionThreshold < MIN_OBFUSCATION_VALUES.deadCodeInjectionThreshold) {
              validationErrors.push('deadCodeInjectionThreshold (' + obfuscationOptions.deadCodeInjectionThreshold + 
                                   ') ä¸èƒ½ä½äºæœ€å°å€¼ ' + MIN_OBFUSCATION_VALUES.deadCodeInjectionThreshold);
          }
          if (obfuscationOptions.stringArrayThreshold < MIN_OBFUSCATION_VALUES.stringArrayThreshold) {
              validationErrors.push('stringArrayThreshold (' + obfuscationOptions.stringArrayThreshold + 
                                   ') ä¸èƒ½ä½äºæœ€å°å€¼ ' + MIN_OBFUSCATION_VALUES.stringArrayThreshold);
          }
          if (obfuscationOptions.stringArrayWrappersCount < MIN_OBFUSCATION_VALUES.stringArrayWrappersCount) {
              validationErrors.push('stringArrayWrappersCount (' + obfuscationOptions.stringArrayWrappersCount + 
                                   ') ä¸èƒ½ä½äºæœ€å°å€¼ ' + MIN_OBFUSCATION_VALUES.stringArrayWrappersCount);
          }
          if (obfuscationOptions.stringArrayWrappersParametersMaxCount < MIN_OBFUSCATION_VALUES.stringArrayWrappersParametersMaxCount) {
              validationErrors.push('stringArrayWrappersParametersMaxCount (' + obfuscationOptions.stringArrayWrappersParametersMaxCount + 
                                   ') ä¸èƒ½ä½äºæœ€å°å€¼ ' + MIN_OBFUSCATION_VALUES.stringArrayWrappersParametersMaxCount);
          }
          if (obfuscationOptions.splitStringsChunkLength < MIN_OBFUSCATION_VALUES.splitStringsChunkLength) {
              validationErrors.push('splitStringsChunkLength (' + obfuscationOptions.splitStringsChunkLength + 
                                   ') ä¸èƒ½ä½äºæœ€å°å€¼ ' + MIN_OBFUSCATION_VALUES.splitStringsChunkLength);
          }
          
          // éªŒè¯å¿…é¡»å¯ç”¨çš„é€‰é¡¹
          const requiredEnabled = ['compact', 'controlFlowFlattening', 'deadCodeInjection', 'stringArray', 
                                   'stringArrayRotate', 'stringArrayShuffle', 'renameGlobals', 
                                   'numbersToExpressions', 'splitStrings', 'unicodeEscapeSequence', 'disableConsoleOutput'];
          for (const key of requiredEnabled) {
              if (MIN_OBFUSCATION_VALUES[key] === true && obfuscationOptions[key] !== true) {
                  validationErrors.push(key + ' å¿…é¡»å¯ç”¨ï¼ˆå½“å‰ä¸º ' + obfuscationOptions[key] + 'ï¼‰ï¼Œä¸èƒ½ç¦ç”¨');
              }
          }
          
          // éªŒè¯å­—ç¬¦ä¸²æ•°ç»„ç¼–ç å¿…é¡»åŒ…å«base64
          if (!obfuscationOptions.stringArrayEncoding || 
              !obfuscationOptions.stringArrayEncoding.includes('base64')) {
              validationErrors.push('stringArrayEncoding å¿…é¡»åŒ…å« "base64" ç¼–ç ');
          }
          
          if (validationErrors.length > 0) {
              console.error('âŒ æ··æ·†å¼ºåº¦éªŒè¯å¤±è´¥ï¼ä»¥ä¸‹é…ç½®è¿åäº†"ä¸èƒ½é™ä½å¼ºåº¦"çš„è§„åˆ™ï¼š');
              validationErrors.forEach(err => console.error('  âœ— ' + err));
              console.error('');
              console.error('âš ï¸  è§„åˆ™ï¼šæ··æ·†å¼ºåº¦åªèƒ½å¢åŠ æˆ–ä¿æŒä¸å˜ï¼Œä¸èƒ½é™ä½ï¼');
              console.error('ğŸ’¡ æç¤ºï¼šå¦‚æœè¦è°ƒæ•´é…ç½®ï¼Œè¯·ç¡®ä¿æ‰€æœ‰å€¼éƒ½ >= æœ€å°å€¼');
              process.exit(1);
          }
          
          console.log('âœ… æ··æ·†å¼ºåº¦é…ç½®éªŒè¯é€šè¿‡ï¼ˆæ‰€æœ‰å€¼å‡ä¸ä½äºæœ€å°å€¼ï¼‰');
          console.log('   - controlFlowFlatteningThreshold: ' + obfuscationOptions.controlFlowFlatteningThreshold + ' (æœ€å°å€¼: 1)');
          console.log('   - deadCodeInjectionThreshold: ' + obfuscationOptions.deadCodeInjectionThreshold + ' (æœ€å°å€¼: 1)');
          console.log('   - stringArrayThreshold: ' + obfuscationOptions.stringArrayThreshold + ' (æœ€å°å€¼: 1.0)');
          console.log('   - stringArrayWrappersCount: ' + obfuscationOptions.stringArrayWrappersCount + ' (æœ€å°å€¼: 2)');
          console.log('   - splitStringsChunkLength: ' + obfuscationOptions.splitStringsChunkLength + ' (æœ€å°å€¼: 1)');

          console.log('å¼€å§‹æ··æ·†ä»£ç ...');
          let obfuscatedCode;
          try {
            const obfuscationResult = JavaScriptObfuscator.obfuscate(originalCode, obfuscationOptions);
            obfuscatedCode = obfuscationResult.getObfuscatedCode();
            console.log('æ··æ·†æˆåŠŸ');
          } catch (obfuscationError) {
            console.error('æ··æ·†å¤±è´¥:', obfuscationError.message);
            console.error('é”™è¯¯å †æ ˆ:', obfuscationError.stack);
            process.exit(1);
          }
          
          fs.writeFileSync(path.join(process.cwd(), outputFileName), obfuscatedCode, 'utf8');
          const outputSize = fs.statSync(path.join(process.cwd(), outputFileName)).size;
          console.log('æˆåŠŸå°† \'' + sourceFileName + '\' æ··æ·†å¹¶ä¿å­˜è‡³ \'' + outputFileName + '\'ã€‚');
          console.log('è¾“å‡ºæ–‡ä»¶å¤§å°: ' + outputSize + ' å­—èŠ‚');
          EOF
          node obfuscate.js

      - name: Prepare release file
        run: |
          WORKSPACE=$(pwd)
          OBFUSCATED_FILE="å°‘å¹´ä½ ç›¸ä¿¡å…‰å—"
          
          # è·å–çŸ­æäº¤å“ˆå¸Œ
          SHORT_SHA=$(git rev-parse --short HEAD)
          RELEASE_FILE="${SHORT_SHA}-å°‘å¹´ä½ ç›¸ä¿¡å…‰å—.txt"
          DEFAULT_FILE="${SHORT_SHA}-default.txt"
          
          if [ ! -f "$OBFUSCATED_FILE" ]; then
            echo "é”™è¯¯ï¼šæ··æ·†æ–‡ä»¶ä¸å­˜åœ¨"
            ls -la
            exit 1
          fi
          
          FILE_SIZE=$(wc -c <"$OBFUSCATED_FILE" || stat -c%s "$OBFUSCATED_FILE" 2>/dev/null || stat -f%z "$OBFUSCATED_FILE" 2>/dev/null || echo "unknown")
          echo "æ··æ·†æ–‡ä»¶å¤§å°: $FILE_SIZE å­—èŠ‚"
          echo "æ–‡ä»¶è·¯å¾„: $WORKSPACE/$OBFUSCATED_FILE"
          
          # åˆ›å»ºä¸¤ä¸ªç‰ˆæœ¬çš„æ–‡ä»¶
          cp "$OBFUSCATED_FILE" "$RELEASE_FILE"
          cp "$OBFUSCATED_FILE" "$DEFAULT_FILE"
          
          echo "release_file=$RELEASE_FILE" >> $GITHUB_ENV
          echo "default_file=$DEFAULT_FILE" >> $GITHUB_ENV
          echo "short_sha=$SHORT_SHA" >> $GITHUB_ENV
          
          TXT_SIZE=$(wc -c <"$RELEASE_FILE" || stat -c%s "$RELEASE_FILE" 2>/dev/null || stat -f%z "$RELEASE_FILE" 2>/dev/null || echo "unknown")
          echo "txtæ–‡ä»¶å¤§å°: $TXT_SIZE å­—èŠ‚"
          echo "Releaseæ–‡ä»¶: $RELEASE_FILE"
          echo "Defaultæ–‡ä»¶: $DEFAULT_FILE"
          
          if [ ! -f "$RELEASE_FILE" ]; then
            echo "é”™è¯¯ï¼šReleaseæ–‡ä»¶åˆ›å»ºå¤±è´¥"
            exit 1
          fi
          
          echo "æ–‡ä»¶å¤§å°éªŒè¯é€šè¿‡"
          ls -lh "$RELEASE_FILE" "$DEFAULT_FILE" || echo "æ–‡ä»¶åˆ—è¡¨å¤±è´¥"

      - name: Commit and force push the obfuscated file
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add 'å°‘å¹´ä½ ç›¸ä¿¡å…‰å—'
          if git diff --staged --quiet; then
            echo "No changes to commit, the obfuscated file is already up-to-date."
          else
            BUILD_DATE=$(date '+%Y-%m-%d %H:%M:%S')
            git commit -m "éƒ¨ç½²ç”¨è¿™ä¸ª - $BUILD_DATE"
            git push --force
          fi

      - name: Get build info
        id: build-info
        run: |
          BUILD_DATE=$(date '+%Y-%m-%d %H:%M:%S')
          BUILD_DATE_CN=$(date '+%Yå¹´%mæœˆ%dæ—¥ %H:%M:%S')
          TAG_NAME=$(date '+v%Y%m%d-%H%M%S')
          echo "build_date=$BUILD_DATE" >> $GITHUB_OUTPUT
          echo "build_date_cn=$BUILD_DATE_CN" >> $GITHUB_OUTPUT
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT

      - name: Verify release file before upload
        run: |
          RELEASE_FILE="${{ env.release_file }}"
          DEFAULT_FILE="${{ env.default_file }}"
          
          if [ ! -f "$RELEASE_FILE" ]; then
            echo "é”™è¯¯ï¼šRelease æ–‡ä»¶ä¸å­˜åœ¨"
            ls -la
            exit 1
          fi
          
          if [ ! -f "$DEFAULT_FILE" ]; then
            echo "é”™è¯¯ï¼šDefault æ–‡ä»¶ä¸å­˜åœ¨"
            ls -la
            exit 1
          fi
          
          FILE_SIZE=$(wc -c <"$RELEASE_FILE" || stat -c%s "$RELEASE_FILE" 2>/dev/null || stat -f%z "$RELEASE_FILE" 2>/dev/null || echo "unknown")
          echo "å‡†å¤‡ä¸Šä¼ çš„æ–‡ä»¶: $RELEASE_FILE"
          echo "æ–‡ä»¶å¤§å°: $FILE_SIZE å­—èŠ‚ ($(($FILE_SIZE / 1024)) KB)"
          if [ "$FILE_SIZE" -lt 1000000 ]; then
            echo "è­¦å‘Šï¼šæ–‡ä»¶å¤§å°å¼‚å¸¸å°ï¼Œå¯èƒ½æœ‰é—®é¢˜"
          fi
          ls -lh "$RELEASE_FILE" "$DEFAULT_FILE"
          pwd
          file "$RELEASE_FILE" || echo "æ–‡ä»¶ç±»å‹æ£€æŸ¥å¤±è´¥"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.build-info.outputs.tag_name }}
          name: "æ„å»ºç‰ˆæœ¬ ${{ steps.build-info.outputs.build_date }}"
          body: |
            ## æ›´æ–°æ—¥å¿—
            
            **æ›´æ–°æ—¥æœŸ**: ${{ steps.build-info.outputs.build_date_cn }}
            
            ### æ›´æ–°å†…å®¹
            - è‡ªåŠ¨æ„å»ºå®Œæˆ
            - æºæ–‡ä»¶å·²æ··æ·†å¹¶è½¬æ¢ä¸ºtxtæ ¼å¼
            
            ### æ„å»ºä¿¡æ¯
            - æ„å»ºæ—¶é—´: ${{ steps.build-info.outputs.build_date }}
            - æ„å»ºåˆ†æ”¯: ${{ github.ref_name }}
            - æäº¤å“ˆå¸Œ: ${{ env.short_sha }} (å®Œæ•´: ${{ github.sha }})
            
            ### æ–‡ä»¶è¯´æ˜
            - **${{ env.short_sha }}-å°‘å¹´ä½ ç›¸ä¿¡å…‰å—.txt**: æ··æ·†åçš„å®Œæ•´ä»£ç æ–‡ä»¶ï¼ˆçº¦1.2MBï¼‰
            - **${{ env.short_sha }}-default.txt**: é»˜è®¤æ–‡ä»¶ï¼ˆä¸ä¸Šé¢å†…å®¹ç›¸åŒï¼‰
          files: |
            ${{ env.release_file }}
            ${{ env.default_file }}
          generate_release_notes: false
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
