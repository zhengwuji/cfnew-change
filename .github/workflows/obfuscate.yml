name: Generate and Obfuscate Worker Script

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  push:
    branches:
      - main
    paths:
      - 'æ˜Žæ–‡æºå—'  # åªæœ‰æ˜Žæ–‡æºå—æ–‡ä»¶å˜æ›´æ—¶æ‰è§¦å‘

jobs:
  build-and-obfuscate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Obfuscator
        run: npm install javascript-obfuscator

      - name: Obfuscate from local source file
        run: |
          cat > obfuscate.js << 'EOF'
          const JavaScriptObfuscator = require('javascript-obfuscator');
          const fs = require('fs');
          const path = require('path');
          
          const sourceFileName = 'æ˜Žæ–‡æºå—';
          const outputFileName = 'å°‘å¹´ä½ ç›¸ä¿¡å…‰å—';
          const sourceFilePath = path.join(process.cwd(), sourceFileName);

          if (!fs.existsSync(sourceFilePath)) {
            console.error('é”™è¯¯ï¼šåœ¨è·¯å¾„ \'' + sourceFilePath + '\' æœªæ‰¾åˆ°æºæ–‡ä»¶ã€‚è¯·ç¡®ä¿æ‚¨çš„ä»“åº“æ ¹ç›®å½•æœ‰åä¸º \'æ˜Žæ–‡æºå—\' çš„æ–‡ä»¶ã€‚');
            process.exit(1);
          }

          const originalCode = fs.readFileSync(sourceFilePath, 'utf8');

          if (!originalCode || originalCode.trim().length === 0) {
            console.error('é”™è¯¯ï¼šæºæ–‡ä»¶ ' + sourceFileName + ' ä¸ºç©ºã€‚');
            process.exit(1);
          }

          const obfuscationOptions = {
              compact: true,
              controlFlowFlattening: false,
              controlFlowFlatteningThreshold: 0,
              deadCodeInjection: false,
              stringArray: true,
              stringArrayEncoding: ['base64'],
              stringArrayThreshold: 1.0,
              stringArrayRotate: true,
              stringArrayShuffle: true,
              stringArrayWrappersCount: 2,
              stringArrayWrappersChainedCalls: false,
              stringArrayWrappersParametersMaxCount: 3,
              renameGlobals: true,
              identifierNamesGenerator: 'mangled-shuffled',
              identifierNamesCache: null,
              identifiersPrefix: '',
              renameProperties: false,
              renamePropertiesMode: 'safe',
              ignoreImports: false,
              target: 'browser',
              numbersToExpressions: false,
              simplify: false,
              splitStrings: true,
              splitStringsChunkLength: 1,
              transformObjectKeys: false,
              unicodeEscapeSequence: true,
              selfDefending: false,
              debugProtection: false,
              debugProtectionInterval: 0,
              disableConsoleOutput: true,
              domainLock: []
          };

          const obfuscatedCode = JavaScriptObfuscator.obfuscate(originalCode, obfuscationOptions).getObfuscatedCode();
          
          fs.writeFileSync(path.join(process.cwd(), outputFileName), obfuscatedCode, 'utf8');
          console.log('æˆåŠŸå°† \'' + sourceFileName + '\' æ··æ·†å¹¶ä¿å­˜è‡³ \'' + outputFileName + '\'ã€‚');
          EOF
          node obfuscate.js

      - name: Get commit information
        id: commit_info
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          COMMIT_SHA=$(git rev-parse --short HEAD)
          COMMIT_AUTHOR=$(git log -1 --pretty=%an)
          COMMIT_DATE=$(git log -1 --pretty=%cd --date=format:'%Y-%m-%d %H:%M:%S')
          UPDATE_DATE=$(date +'%Y-%m-%d %H:%M:%S')
          VERSION=$(date +'v%Y%m%d-%H%M%S')
          
          echo "commit_msg<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMIT_MSG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
          echo "commit_author=$COMMIT_AUTHOR" >> $GITHUB_OUTPUT
          echo "commit_date=$COMMIT_DATE" >> $GITHUB_OUTPUT
          echo "update_date=$UPDATE_DATE" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
          echo "æäº¤ä¿¡æ¯: $COMMIT_MSG"
          echo "æäº¤SHA: $COMMIT_SHA"
          echo "æäº¤ä½œè€…: $COMMIT_AUTHOR"
          echo "æäº¤æ—¥æœŸ: $COMMIT_DATE"
          echo "æ›´æ–°æ—¥æœŸ: $UPDATE_DATE"
          echo "ç‰ˆæœ¬å·: $VERSION"

      - name: Commit and push the obfuscated file
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add 'å°‘å¹´ä½ ç›¸ä¿¡å…‰å—'
          if git diff --staged --quiet; then
            echo "No changes to commit, the obfuscated file is already up-to-date."
            echo "has_changes=false" >> $GITHUB_ENV
          else
            git commit -m "éƒ¨ç½²ç”¨è¿™ä¸ª"
            git push
            echo "has_changes=true" >> $GITHUB_ENV
          fi

      - name: Prepare release files
        if: env.has_changes == 'true'
        run: |
          # å¤åˆ¶æ··æ·†åŽçš„æ–‡ä»¶
          cp "å°‘å¹´ä½ ç›¸ä¿¡å…‰å—" "_worker.js"
          echo "æˆåŠŸå°† 'å°‘å¹´ä½ ç›¸ä¿¡å…‰å—' å¤åˆ¶ä¸º '_worker.js'"
          
          # åˆ›å»ºåŽ‹ç¼©åŒ…
          zip Pages.zip _worker.js
          echo "æˆåŠŸåˆ›å»ºåŽ‹ç¼©åŒ… 'Pages.zip'"

      - name: Create GitHub Release
        if: env.has_changes == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.commit_info.outputs.version }}
          name: æž„å»ºç‰ˆæœ¬ ${{ steps.commit_info.outputs.version }}
          body: |
            ## ðŸ“¦ æž„å»ºä¿¡æ¯
            
            - **ç‰ˆæœ¬å·**: ${{ steps.commit_info.outputs.version }}
            - **æ›´æ–°æ—¥æœŸ**: ${{ steps.commit_info.outputs.update_date }}
            - **æäº¤æ—¥æœŸ**: ${{ steps.commit_info.outputs.commit_date }}
            - **æäº¤SHA**: ${{ steps.commit_info.outputs.commit_sha }}
            - **æäº¤ä½œè€…**: ${{ steps.commit_info.outputs.commit_author }}
            
            ## ðŸ“ æ›´æ–°æ—¥å¿—
            
            ```
            ${{ steps.commit_info.outputs.commit_msg }}
            ```
            
            ## ðŸ“„ æ–‡ä»¶è¯´æ˜Ž
            
            - **æºæ–‡ä»¶**: æ˜Žæ–‡æºå—
            - **æ··æ·†æ–‡ä»¶**: å°‘å¹´ä½ ç›¸ä¿¡å…‰å—
            - **éƒ¨ç½²æ–‡ä»¶**: _worker.js
            - **åŽ‹ç¼©åŒ…**: Pages.zip
            
            ## ðŸš€ ä½¿ç”¨æ–¹æ³•
            
            1. ä¸‹è½½ `Pages.zip` åŽ‹ç¼©åŒ…
            2. è§£åŽ‹åŽå¾—åˆ° `_worker.js` æ–‡ä»¶
            3. åœ¨ Cloudflare Pages ä¸­ä¸Šä¼  `_worker.js` æ–‡ä»¶è¿›è¡Œéƒ¨ç½²
            
            ---
            
            **è‡ªåŠ¨æž„å»ºæ—¶é—´**: ${{ steps.commit_info.outputs.update_date }}
          draft: false
          prerelease: false
          files: |
            Pages.zip
            _worker.js
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Output summary
        if: env.has_changes == 'true'
        run: |
          echo "## âœ… æž„å»ºå®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ æž„å»ºä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬å·**: ${{ steps.commit_info.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æ›´æ–°æ—¥æœŸ**: ${{ steps.commit_info.outputs.update_date }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤ä¿¡æ¯**: ${{ steps.commit_info.outputs.commit_msg }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤SHA**: ${{ steps.commit_info.outputs.commit_sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“„ ç”Ÿæˆæ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… å°‘å¹´ä½ ç›¸ä¿¡å…‰å— (æ··æ·†åŽçš„ä»£ç )" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… _worker.js (éƒ¨ç½²æ–‡ä»¶)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Pages.zip (åŽ‹ç¼©åŒ…)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ GitHub Release" >> $GITHUB_STEP_SUMMARY
          echo "âœ… å·²è‡ªåŠ¨åˆ›å»º Release: ${{ steps.commit_info.outputs.version }}" >> $GITHUB_STEP_SUMMARY
